<div class="px-4 sm:px-6 lg:px-8">
  <!-- Page Header -->
  <div class="sm:flex sm:items-center sm:justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Venue Image Enrichment Operations</h1>
      <p class="mt-2 text-sm text-gray-700">
        Image enrichment job history with retry capabilities for failed uploads
      </p>
    </div>
    <div class="mt-4 sm:mt-0 flex gap-3">
      <button
        phx-click="retry_all_failed"
        class="inline-flex items-center px-4 py-2 border border-orange-300 rounded-md shadow-sm text-sm font-medium text-orange-700 bg-orange-50 hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
        title="Retry all venues with transient failures (rate limits, network issues)"
      >
        🔄 Retry All Failed
      </button>
      <button
        phx-click="refresh"
        class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        🔄 Refresh
      </button>
    </div>
  </div>

  <%= if @loading do %>
    <div class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
      <p class="mt-2 text-sm text-gray-500">Loading operations...</p>
    </div>
  <% else %>
    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600">Total Operations</div>
        <div class="text-2xl font-bold text-gray-900"><%= length(@operations) %></div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600">Images Uploaded</div>
        <div class="text-2xl font-bold text-green-600">
          <%= Enum.sum(Enum.map(@operations, & &1.images_uploaded)) %>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600">Images Failed</div>
        <div class="text-2xl font-bold text-red-600">
          <%= Enum.sum(Enum.map(@operations, & &1.images_failed)) %>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-600">Retryable Failures</div>
        <div class="text-2xl font-bold text-orange-600">
          <%= Enum.count(@operations, &has_retryable_failures?/1) %>
        </div>
      </div>
    </div>

    <!-- Recent Operations -->
    <div class="bg-white rounded-lg shadow mb-8">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">Recent Operations (Last 50)</h2>
            <p class="mt-1 text-sm text-gray-500">
              Complete operation history showing all venue enrichment attempts
            </p>
          </div>
          <div class="flex items-center gap-4">
            <!-- Provider Filter -->
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-600">Provider:</label>
              <form phx-change="filter_provider">
                <select name="provider" class="text-xs border-gray-300 rounded-md">
                  <option value="all" selected={@provider_filter == :all}>All Providers</option>
                  <%= for provider <- @providers do %>
                    <option value={provider} selected={@provider_filter == provider}>
                      <%= format_provider_name(provider) %>
                    </option>
                  <% end %>
                </select>
              </form>
            </div>
            <!-- Error Type Filter -->
            <div class="flex items-center gap-2">
              <label class="text-xs text-gray-600">Error Type:</label>
              <form phx-change="filter_error_type">
                <select name="error_type" class="text-xs border-gray-300 rounded-md">
                  <option value="all" selected={@error_type_filter == :all}>All Errors</option>
                  <%= for error_type <- @error_types do %>
                    <option value={error_type} selected={@error_type_filter == error_type}>
                      <%= format_error_type(error_type) %>
                    </option>
                  <% end %>
                </select>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <% filtered_ops =
          @operations
          |> Enum.filter(fn op ->
            # Provider filter
            (@provider_filter == :all or @provider_filter in Map.keys(op.providers)) and
              # Error type filter
              (@error_type_filter == :all or
                 @error_type_filter in Map.keys(op.failure_breakdown))
          end) %>

        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Time
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Venue
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Status
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Duration
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Results
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Cost
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <%= for op <- filtered_ops do %>
              <% job_id = "job-#{op.id}" %>
              <% is_expanded = MapSet.member?(@expanded_job_ids, job_id) %>
              <% has_failures = op.images_failed > 0 %>
              <% can_retry = has_retryable_failures?(op) %>

              <tr class={[
                if(has_failures, do: "bg-orange-50", else: ""),
                "cursor-pointer hover:bg-gray-50"
              ]}>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= format_datetime(op.completed_at) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <%= if op.venue_id do %>
                    <span class="font-mono text-gray-700">Venue #<%= op.venue_id %></span>
                  <% else %>
                    <span class="text-gray-500">Batch</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={"px-2 inline-flex text-xs leading-5 font-semibold rounded-full #{status_badge_class(op.state)}"}>
                    <%= op.state |> String.capitalize() %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= format_duration(op.duration_seconds) %>
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                  <div class="flex items-center justify-between">
                    <span>
                      <%= op.images_discovered %> discovered
                      · <span class="text-green-600"><%= op.images_uploaded %> uploaded</span>
                      <%= if op.images_failed > 0 do %>
                        · <span class="text-red-600"><%= op.images_failed %> failed</span>
                      <% end %>
                    </span>
                    <button
                      phx-click="toggle_job_details"
                      phx-value-job_id={job_id}
                      class="ml-2 text-blue-600 hover:text-blue-800 text-xs font-medium flex-shrink-0"
                    >
                      <%= if is_expanded, do: "Hide Details ▲", else: "Show Details ▼" %>
                    </button>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  $<%= format_cost(op.total_cost_usd) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <%= if can_retry and op.venue_id do %>
                    <button
                      phx-click="retry_venue"
                      phx-value-venue_id={op.venue_id}
                      class="text-orange-600 hover:text-orange-800 font-medium"
                      title="Retry transient failures for this venue"
                    >
                      🔄 Retry
                    </button>
                  <% else %>
                    <span class="text-gray-400">—</span>
                  <% end %>
                </td>
              </tr>

              <%= if is_expanded do %>
                <tr class="bg-blue-50">
                  <td colspan="7" class="px-6 py-4">
                    <div class="space-y-4">
                      <!-- Operation Summary -->
                      <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Operation Summary</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                          <div>
                            <span class="text-gray-600">Images Discovered:</span>
                            <span class="ml-2 font-medium"><%= op.images_discovered %></span>
                          </div>
                          <div>
                            <span class="text-gray-600">Uploaded:</span>
                            <span class="ml-2 font-medium text-green-600"><%= op.images_uploaded %></span>
                          </div>
                          <div>
                            <span class="text-gray-600">Failed:</span>
                            <span class="ml-2 font-medium text-red-600"><%= op.images_failed %></span>
                          </div>
                          <div>
                            <span class="text-gray-600">Duration:</span>
                            <span class="ml-2 font-medium"><%= format_duration(op.duration_seconds) %></span>
                          </div>
                          <div>
                            <span class="text-gray-600">Cost:</span>
                            <span class="ml-2 font-medium">$<%= format_cost(op.total_cost_usd) %></span>
                          </div>
                          <div>
                            <span class="text-gray-600">Oban Job ID:</span>
                            <span class="ml-2 font-mono text-xs">#<%= op.id %></span>
                          </div>
                          <%= if op.venue_id do %>
                            <div>
                              <span class="text-gray-600">Venue ID:</span>
                              <span class="ml-2 font-mono text-xs">#<%= op.venue_id %></span>
                            </div>
                          <% end %>
                        </div>
                        <%= if op.summary && op.summary != "" do %>
                          <div class="mt-2">
                            <span class="text-gray-600">Summary:</span>
                            <span class="ml-2 text-sm"><%= op.summary %></span>
                          </div>
                        <% end %>
                      </div>

                      <!-- Provider Breakdown -->
                      <%= if map_size(op.providers) > 0 do %>
                        <div>
                          <h4 class="text-sm font-semibold text-gray-700 mb-2">Provider Results</h4>
                          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <%= for {provider, details} <- op.providers do %>
                              <div class={"px-3 py-2 rounded-lg border " <> if(details["status"] == "success", do: "bg-green-50 border-green-200", else: "bg-red-50 border-red-200")}>
                                <div class="flex items-center justify-between">
                                  <span class={"text-xs font-medium " <> provider_badge_class(provider)}>
                                    <%= format_provider_name(provider) %>
                                  </span>
                                  <span class="text-xs">
                                    <%= if details["status"] == "success", do: "✅", else: "❌" %>
                                  </span>
                                </div>
                                <%= if details["status"] == "success" do %>
                                  <div class="mt-1 text-xs text-gray-600">
                                    <%= details["images_uploaded"] || 0 %> uploaded
                                  </div>
                                <% else %>
                                  <div class="mt-1 text-xs text-red-600">
                                    <%= details["reason"] || "Failed" %>
                                  </div>
                                <% end %>
                              </div>
                            <% end %>
                          </div>
                        </div>
                      <% end %>

                      <!-- Failure Breakdown -->
                      <%= if map_size(op.failure_breakdown) > 0 do %>
                        <div>
                          <h4 class="text-sm font-semibold text-gray-700 mb-2">
                            Failure Breakdown (<%= op.images_failed %> failed images)
                          </h4>
                          <div class="flex flex-wrap gap-2">
                            <%= for {error_type, count} <- op.failure_breakdown do %>
                              <span class={"px-3 py-1 text-sm rounded-full #{error_type_badge_class(error_type)}"}>
                                <%= error_type_icon(error_type) %>
                                <%= format_error_type(error_type) %>: <%= count %>
                                <%= if is_transient_error?(error_type) do %>
                                  <span class="ml-1 text-xs">(retryable)</span>
                                <% end %>
                              </span>
                            <% end %>
                          </div>
                        </div>
                      <% end %>

                      <!-- Failed Images Details -->
                      <%= if length(op.failed_images) > 0 do %>
                        <div>
                          <h4 class="text-sm font-semibold text-gray-700 mb-2">Failed Images</h4>
                          <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded">
                              <thead class="bg-gray-100">
                                <tr>
                                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">
                                    Provider
                                  </th>
                                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">
                                    Error Type
                                  </th>
                                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">
                                    Status Code
                                  </th>
                                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">
                                    Timestamp
                                  </th>
                                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">
                                    URL
                                  </th>
                                </tr>
                              </thead>
                              <tbody class="divide-y divide-gray-200">
                                <%= for failed_img <- op.failed_images do %>
                                  <tr class="text-xs">
                                    <td class="px-4 py-2">
                                      <span class={"px-2 py-1 rounded " <> provider_badge_class(failed_img["provider"])}>
                                        <%= format_provider_name(failed_img["provider"]) %>
                                      </span>
                                    </td>
                                    <td class="px-4 py-2">
                                      <span class={"px-2 py-1 rounded " <> error_type_badge_class(failed_img["error_type"])}>
                                        <%= error_type_icon(failed_img["error_type"]) %>
                                        <%= format_error_type(failed_img["error_type"]) %>
                                      </span>
                                    </td>
                                    <td class="px-4 py-2 text-center font-mono">
                                      <%= failed_img["status_code"] || "—" %>
                                    </td>
                                    <td class="px-4 py-2 text-gray-500">
                                      <%= failed_img["timestamp"] || "—" %>
                                    </td>
                                    <td class="px-4 py-2">
                                      <%= if failed_img["provider_url"] do %>
                                        <a
                                          href={failed_img["provider_url"]}
                                          target="_blank"
                                          class="text-blue-600 hover:text-blue-800 text-xs truncate block max-w-xs"
                                          title={failed_img["provider_url"]}
                                        >
                                          <%= String.slice(failed_img["provider_url"], 0..60) %>...
                                        </a>
                                      <% else %>
                                        <span class="text-gray-400">—</span>
                                      <% end %>
                                    </td>
                                  </tr>
                                <% end %>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      <% end %>

                      <!-- ImageKit URLs -->
                      <%= if length(op.imagekit_urls) > 0 do %>
                        <div>
                          <h4 class="text-sm font-semibold text-gray-700 mb-2">
                            Successfully Uploaded (<%= length(op.imagekit_urls) %> images)
                          </h4>
                          <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <%= for url <- Enum.take(op.imagekit_urls, 8) do %>
                              <a href={url} target="_blank" class="group">
                                <img
                                  src={url <> "?tr=w-200,h-150"}
                                  alt="Venue image"
                                  class="w-full h-32 object-cover rounded border border-gray-200 group-hover:border-blue-500"
                                />
                              </a>
                            <% end %>
                          </div>
                          <%= if length(op.imagekit_urls) > 8 do %>
                            <p class="text-xs text-gray-500 mt-2">
                              And <%= length(op.imagekit_urls) - 8 %> more...
                            </p>
                          <% end %>
                        </div>
                      <% end %>

                      <!-- Raw Job Data -->
                      <details class="text-xs">
                        <summary class="cursor-pointer text-gray-600 hover:text-gray-800 font-medium">
                          Show Raw Job Data
                        </summary>
                        <div class="mt-2 space-y-2">
                          <div>
                            <h5 class="font-semibold text-gray-700 mb-1">Arguments:</h5>
                            <pre class="bg-gray-100 p-2 rounded overflow-x-auto"><%= format_json(op.args) %></pre>
                          </div>
                        </div>
                      </details>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% end %>

            <%= if Enum.empty?(filtered_ops) do %>
              <tr>
                <td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">
                  No operations found matching your filters
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>
