<div class="min-h-screen bg-gray-50 py-8" x-data={@alpine_data}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Unsplash Image Management</h1>
          <p class="mt-2 text-gray-600">
            Visual verification of cached Unsplash images with daily rotation
          </p>
        </div>
        <div class="flex gap-4">
          <.form :let={_f} for={%{}} action={~p"/admin/unsplash/refresh-all-cities"} method="post">
            <button
              type="submit"
              class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors shadow-lg flex items-center gap-2"
            >
              <span class="text-xl">üèôÔ∏è</span>
              <div class="text-left">
                <div>Refresh All Cities</div>
                <div class="text-xs text-indigo-100"><%= @cities_for_refresh_count %> cities (venue_count ‚â• 3)</div>
              </div>
            </button>
          </.form>
          <.form :let={_f} for={%{}} action={~p"/admin/unsplash/refresh-all-countries"} method="post">
            <button
              type="submit"
              class="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-colors shadow-lg flex items-center gap-2"
            >
              <span class="text-xl">üåç</span>
              <div class="text-left">
                <div>Refresh All Countries</div>
                <div class="text-xs text-purple-100"><%= @countries_for_refresh_count %> countries</div>
              </div>
            </button>
          </.form>
        </div>
      </div>

      <!-- Stats Summary -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="text-sm text-gray-600">Cities with Galleries</div>
          <div class="text-2xl font-bold text-gray-900"><%= @cities_with_galleries_count %></div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="text-sm text-gray-600">Countries with Galleries</div>
          <div class="text-2xl font-bold text-gray-900"><%= @countries_with_galleries_count %></div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="text-sm text-gray-600">City Images</div>
          <div class="text-2xl font-bold text-gray-900"><%= @total_city_images %></div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="text-sm text-gray-600">Country Images</div>
          <div class="text-2xl font-bold text-gray-900"><%= @total_country_images %></div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
          <div class="text-sm text-gray-600">Day of Year</div>
          <div class="text-2xl font-bold text-gray-900"><%= @day_of_year %></div>
        </div>
      </div>

      <!-- Search Box -->
      <div class="mb-6">
        <form method="get" action={~p"/admin/unsplash"} class="flex gap-3">
          <input
            type="text"
            name="search"
            value={@search_query}
            placeholder="Search cities by name..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          />
          <button
            type="submit"
            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
          >
            Search
          </button>
          <%= if @search_query != "" do %>
            <a
              href={~p"/admin/unsplash"}
              class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
            >
              Clear
            </a>
          <% end %>
        </form>
      </div>

      <!-- Pagination Info -->
      <div class="flex items-center justify-between mb-4">
        <div class="text-sm text-gray-600">
          Showing <%= length(@cities) %> of <%= @total_filtered_cities %> cities
          <%= if @search_query != "" do %>
            matching "<%= @search_query %>"
          <% end %>
          (Page <%= @current_page %> of <%= @total_pages %>)
        </div>
      </div>
    </div>

    <!-- City Cards (Compact) -->
    <%= if @cities == [] do %>
      <div class="p-8 bg-yellow-50 border border-yellow-200 rounded-lg text-center mb-8">
        <h3 class="text-lg font-semibold text-yellow-900 mb-2">No Cities Found</h3>
        <p class="text-sm text-yellow-700">
          <%= if @search_query != "" do %>
            No cities match your search "<%= @search_query %>". Try a different search term.
          <% else %>
            No cached image galleries yet. Click "Refresh All Cities" to populate galleries.
          <% end %>
        </p>
      </div>
    <% else %>
      <div class="space-y-3 mb-8">
        <%= for city <- @cities do %>
          <div class="bg-white rounded-lg shadow hover:shadow-md transition-shadow">
            <!-- Compact Card Header -->
            <div
              class="px-6 py-4 cursor-pointer"
              data-city-id={city.id}
              x-on:click="expandedCity = expandedCity === $el.dataset.cityId ? null : $el.dataset.cityId"
            >
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-3">
                    <h3 class="text-lg font-semibold text-gray-900"><%= city.name %></h3>
                    <span class="px-2 py-1 text-xs font-medium bg-indigo-100 text-indigo-800 rounded">
                      <%= city.image_count %> images
                    </span>
                    <%= if city.format == :categorized do %>
                      <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">
                        <%= city.category_count %> categories
                      </span>
                    <% end %>
                  </div>
                  <div class="text-sm text-gray-500 mt-1">
                    Last refreshed: <%= if city.format == :legacy and not is_nil(city.last_refreshed) do %>
                      <%= city.last_refreshed |> String.slice(0..18) %> UTC
                    <% else %>
                      <%= if city.format == :categorized and length(city.tab_categories) > 0 do %>
                        <%= {_, first_cat} = List.first(city.tab_categories); first_cat.last_refreshed |> String.slice(0..18) %> UTC
                      <% else %>
                        Never
                      <% end %>
                    <% end %>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <.form :let={_f} for={%{}} action={~p"/admin/unsplash/fetch/#{city.id}"} method="post">
                    <button
                      type="submit"
                      class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                      x-on:click.stop
                    >
                      üîÑ Refresh
                    </button>
                  </.form>
                  <svg
                    class="w-5 h-5 text-gray-400 transition-transform"
                    x-bind:class={"expandedCity === '#{city.id}' && 'rotate-180'"}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Expanded Content -->
            <div x-show={"expandedCity === '#{city.id}'"} x-collapse>
              <div class="px-6 pb-6 border-t border-gray-200">
                <%= if city.format == :categorized do %>
                  <!-- Categorized Format -->
                  <div class="mt-4">
                    <div class="flex gap-2 mb-4">
                      <%= for {category_name, _} <- city.tab_categories do %>
                        <button
                          x-on:click={"activeCategory_#{city.id} = '#{category_name}'"}
                          x-bind:class={"activeCategory_#{city.id} === '#{category_name}' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'"}
                          class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors"
                        >
                          <%= category_name |> String.replace("_", " ") |> String.capitalize() %>
                        </button>
                      <% end %>
                    </div>

                    <%= for {category_name, category_data} <- city.tab_categories do %>
                      <div x-show={"activeCategory_#{city.id} === '#{category_name}'"} class="space-y-3">
                        <div class="text-sm text-gray-600">
                          <strong>Search Terms:</strong> <%= Enum.join(category_data.search_terms, ", ") %>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                          <%= for {image, index} <- Enum.with_index(category_data.images) do %>
                            <div class="relative group">
                              <img
                                src={image["thumb_url"]}
                                alt={"#{city.name} - #{category_name} - Image #{index}"}
                                class="w-full h-40 object-cover rounded-lg"
                              />
                              <%= if index == category_data.current_index do %>
                                <div class="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded font-medium">
                                  TODAY
                                </div>
                              <% end %>
                              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity">
                                by <%= image["attribution"]["photographer_name"] %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <!-- Legacy Format -->
                  <div class="mt-4">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                      <%= for {image, index} <- Enum.with_index(city.images) do %>
                        <div class="relative group">
                          <img
                            src={image["thumb_url"]}
                            alt={"#{city.name} - Image #{index}"}
                            class="w-full h-40 object-cover rounded-lg"
                          />
                          <%= if index == city.current_index do %>
                            <div class="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded font-medium">
                              TODAY
                            </div>
                          <% end %>
                          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity">
                            by <%= image["attribution"]["photographer_name"] %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Pagination Controls -->
    <%= if @total_pages > 1 do %>
      <div class="flex items-center justify-center gap-2 mb-8">
        <!-- Previous Button -->
        <%= if @current_page > 1 do %>
          <a
            href={~p"/admin/unsplash?page=#{@current_page - 1}&search=#{@search_query}"}
            class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            Previous
          </a>
        <% else %>
          <span class="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-400 cursor-not-allowed">
            Previous
          </span>
        <% end %>

        <!-- Page Numbers -->
        <%= for page_num <- max(1, @current_page - 2)..min(@total_pages, @current_page + 2) do %>
          <%= if page_num == @current_page do %>
            <span class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium">
              <%= page_num %>
            </span>
          <% else %>
            <a
              href={~p"/admin/unsplash?page=#{page_num}&search=#{@search_query}"}
              class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <%= page_num %>
            </a>
          <% end %>
        <% end %>

        <!-- Next Button -->
        <%= if @current_page < @total_pages do %>
          <a
            href={~p"/admin/unsplash?page=#{@current_page + 1}&search=#{@search_query}"}
            class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            Next
          </a>
        <% else %>
          <span class="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-400 cursor-not-allowed">
            Next
          </span>
        <% end %>
      </div>
    <% end %>

    <!-- Countries Section (Simplified) -->
    <%= if length(@countries) > 0 do %>
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Country Galleries</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <%= for country <- @countries do %>
            <div class="bg-white rounded-lg shadow p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900"><%= country.name %></h3>
                <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">
                  <%= country.image_count %> images
                </span>
              </div>
              <div class="text-sm text-gray-600 mb-3">
                <%= country.category_count %> categories
              </div>
              <%= if length(country.tab_categories) > 0 do %>
                <% {_, first_cat} = List.first(country.tab_categories) %>
                <%= if length(first_cat.images) > 0 do %>
                  <% first_image = List.first(first_cat.images) %>
                  <img
                    src={first_image["thumb_url"]}
                    alt={"#{country.name} preview"}
                    class="w-full h-40 object-cover rounded-lg mb-3"
                  />
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>
